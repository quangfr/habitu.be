<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Routine Buddy Â· Prototype</title>
<style>
:root{
  --bg:#0b0f14; --panel:#0f1620; --muted:#9fb0c0; --text:#e9f1f7; --ok:#2ecc71; --warn:#f1c40f; --bad:#ff5a5f;
  --cat-Nutrition:#FFB703; --cat-HygiÃ¨ne:#8ECAE6; --cat-Exercice:#2A9D8F; --cat-Sommeil:#4A4E69; --cat-Social:#F4A261; --cat-Autre:#9B5DE5;
  --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#091019,#0b0f14 60%);color:var(--text);font:16px/1.3 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}
.app{min-height:100svh;display:flex;flex-direction:column;}
header{position:sticky;top:0;z-index:4;background:rgba(15,22,32,.9);backdrop-filter:blur(8px);border-bottom:1px solid #182230}
.head-wrap{display:flex;align-items:center;gap:12px;padding:10px 12px;}
.h-title{font-weight:700;letter-spacing:.3px}
.h-grow{flex:1}
.date-row{display:flex;gap:8px;align-items:center}
.date-row input[type=date]{appearance:none;background:#101827;border:1px solid #223046;color:var(--text);padding:8px 10px;border-radius:12px}
.icon-btn{background:#101827;border:1px solid #223046;color:var(--text);border-radius:12px;padding:8px 10px;display:inline-flex;align-items:center;gap:8px}
.icon-btn:active{transform:translateY(1px)}

main{flex:1;display:grid;grid-template-rows:auto 1fr;gap:10px;padding:10px;}
.summary{display:flex;align-items:center;gap:10px;border:1px solid #1a2636;border-radius:var(--radius);padding:10px;background:linear-gradient(180deg,#0f1620,#0c131c)}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #223046;background:#0e1520;color:var(--muted)}
.progress{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;position:relative;background:
  conic-gradient(var(--ok) calc(var(--p)*1%), #243244 0);
}
.progress::after{content:"";position:absolute;inset:6px;background:#0c131c;border-radius:50%;border:1px solid #1a2636}
.progress span{position:relative;font-weight:700;font-size:14px}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.card{background:linear-gradient(180deg,#0f1723,#0b121c);border:1px solid #1a2636;border-radius:var(--radius);padding:10px;display:flex;flex-direction:column;gap:10px;min-height:130px;}
.card-head{display:flex;align-items:center;gap:8px}
.card-head .dot{width:10px;height:10px;border-radius:50%}
.card h3{margin:0;font-size:16px;font-weight:700}
.status{margin-left:auto;border-radius:10px;padding:4px 8px;font-size:12px;border:1px solid #223046;color:#cfd9e3;background:#101827}
.count{font-size:13px;color:var(--muted)}
.emoji-row{display:flex;flex-wrap:wrap;gap:6px}
.emoji{font-size:20px;filter:saturate(1.2)}
.card{border-width:2px}
.card[data-status="red"]{border-color:var(--bad)}
.card[data-status="yellow"]{border-color:var(--warn)}
.card[data-status="green"]{border-color:var(--ok)}

/* Category view */
.view{display:none}
.view.active{display:block}
.cat-head{display:flex;align-items:center;gap:8px;margin:6px 0 10px}
.back{padding:8px 10px;border-radius:12px;border:1px solid #223046;background:#101827;color:var(--text)}
.add{margin-left:auto}
.task{position:relative;background:#0f1723;border:1px solid #1a2636;border-radius:14px;padding:10px;display:flex;align-items:center;gap:10px;touch-action:pan-y}
.task + .task{margin-top:10px}
.task .em{font-size:22px}
.task .title{font-weight:600}
.badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #2a3a52;color:#b9c6d6;background:#0c141f}
.line{margin-left:auto;display:flex;gap:6px;align-items:center}
.task.done{opacity:.6;text-decoration:line-through}
.swipe-hint{position:absolute;inset:0;border-radius:inherit;background:linear-gradient(90deg,rgba(46,204,113,.2),transparent 50%);pointer-events:none;opacity:0;transition:opacity .2s}
.task.swiping .swipe-hint{opacity:1}

/* Dialog */
dialog{border:none;border-radius:16px;padding:0;background:#0f1723;color:var(--text);width:min(92vw,420px)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1a2636}
.modal-body{padding:12px 14px;display:grid;gap:10px}
.modal-body input, .modal-body select{background:#101827;border:1px solid #223046;color:var(--text);padding:10px;border-radius:12px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #1a2636}

footer{position:sticky;bottom:0;background:rgba(15,22,32,.9);backdrop-filter:blur(8px);border-top:1px solid #182230}
.nav{display:flex;gap:8px;padding:8px}
.nav button{flex:1;border-radius:12px;border:1px solid #223046;background:#101827;color:var(--text);padding:10px;font-weight:600}

/* Small devices */
@media (max-width:420px){
  .grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="head-wrap">
      <div class="h-title">ğŸ·ï¸ Routine Buddy</div>
      <div class="h-grow"></div>
      <div class="date-row">
        <span class="pill" id="todayLabel">Aujourd'hui</span>
        <input id="dayPicker" type="date" />
      </div>
      <button class="icon-btn" id="resetDay" title="Revenir Ã  aujourd'hui">â†º</button>
    </div>
  </header>

  <main>
    <section class="summary" id="summary">
      <div class="progress" id="progress" style="--p:0"><span id="pct">0%</span></div>
      <div>
        <div style="font-weight:700">Progression du jour</div>
        <div class="count" id="sumLine">0/0 tÃ¢ches faites</div>
        <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
          <span class="pill">ğŸŸ¥ Obligatoires restantes</span>
          <span class="pill">ğŸŸ¨ ConseillÃ©es restantes</span>
          <span class="pill">ğŸŸ© Tout fait = vert</span>
        </div>
      </div>
    </section>

    <section id="home" class="view active">
      <div class="grid" id="catGrid"></div>
    </section>

    <section id="category" class="view">
      <div class="cat-head">
        <button class="back" id="backBtn">â† Accueil</button>
        <h2 id="catTitle" style="margin:0"></h2>
        <button class="icon-btn add" id="addBtn">+ Ajouter</button>
      </div>
      <div id="taskList"></div>
    </section>
  </main>

  <footer>
    <div class="nav">
      <button id="navHome">ğŸ  Accueil</button>
      <button id="navHistory">ğŸ“… Historique</button>
    </div>
  </footer>
</div>

<dialog id="taskDialog">
  <form method="dialog" id="taskForm">
    <div class="modal-head"><strong>Nouvelle tÃ¢che</strong><button type="button" class="icon-btn" id="closeDialog">âœ–</button></div>
    <div class="modal-body">
      <input type="text" id="f_title" placeholder="Titre (ex: Brossage dents)" required />
      <input type="text" id="f_emoji" placeholder="Ã‰moji (ex: ğŸ˜)" list="emojiList" maxlength="2" />
      <datalist id="emojiList">
        <option>ğŸ</option><option>ğŸ¥—</option><option>ğŸ¥›</option><option>ğŸš¿</option><option>ğŸª¥</option><option>ğŸƒ</option><option>ğŸ§˜</option><option>ğŸ’ª</option><option>ğŸ˜´</option><option>ğŸ“µ</option><option>ğŸ¤</option><option>ğŸ’¬</option><option>ğŸ¯</option>
      </datalist>
      <select id="f_importance">
        <option value="must">Obligatoire</option>
        <option value="nice">ConseillÃ©</option>
      </select>
      <select id="f_recur">
        <option value="daily">Tous les jours</option>
        <option value="weekly">1Ã—/semaine</option>
        <option value="everyX">Tous les X jours</option>
      </select>
      <div id="recurWeeklyWrap" style="display:none">
        <select id="f_weekday">
          <option value="1">Lundi</option><option value="2">Mardi</option><option value="3">Mercredi</option><option value="4">Jeudi</option><option value="5">Vendredi</option><option value="6">Samedi</option><option value="0">Dimanche</option>
        </select>
      </div>
      <div id="recurEveryXWrap" style="display:none">
        <input type="number" id="f_everyX" min="2" max="30" value="3" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="icon-btn" value="cancel">Annuler</button>
      <button class="icon-btn" id="saveTask" value="default">Enregistrer</button>
    </div>
  </form>
</dialog>

<script>
const TZ = 'Europe/Paris'
const fmtDate = (d)=> new Date(d).toLocaleDateString('en-CA',{timeZone:TZ}) // YYYY-MM-DD
const todayISO = ()=> fmtDate(Date.now())
const uid = ()=> Math.random().toString(36).slice(2,9)

const CATS=[
  {id:'Nutrition', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Nutrition').trim()},
  {id:'HygiÃ¨ne', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-HygiÃ¨ne').trim()},
  {id:'Exercice', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Exercice').trim()},
  {id:'Sommeil', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Sommeil').trim()},
  {id:'Social', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Social').trim()},
  {id:'Autre', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Autre').trim()}
]

const STORE_KEY='ROUTINE_BUDDY_V1'
let state = load() || seed()

// Elements
const els={
  dayPicker: document.getElementById('dayPicker'),
  todayLabel: document.getElementById('todayLabel'),
  resetDay: document.getElementById('resetDay'),
  pct: document.getElementById('pct'),
  progress: document.getElementById('progress'),
  sumLine: document.getElementById('sumLine'),
  catGrid: document.getElementById('catGrid'),
  home: document.getElementById('home'),
  category: document.getElementById('category'),
  backBtn: document.getElementById('backBtn'),
  catTitle: document.getElementById('catTitle'),
  taskList: document.getElementById('taskList'),
  navHome: document.getElementById('navHome'),
  navHistory: document.getElementById('navHistory'),
  addBtn: document.getElementById('addBtn'),
  taskDialog: document.getElementById('taskDialog'),
  f_title: document.getElementById('f_title'),
  f_emoji: document.getElementById('f_emoji'),
  f_importance: document.getElementById('f_importance'),
  f_recur: document.getElementById('f_recur'),
  f_weekday: document.getElementById('f_weekday'),
  recurWeeklyWrap: document.getElementById('recurWeeklyWrap'),
  recurEveryXWrap: document.getElementById('recurEveryXWrap'),
  f_everyX: document.getElementById('f_everyX'),
  closeDialog: document.getElementById('closeDialog'),
  saveTask: document.getElementById('saveTask'),
}

// Init date picker
els.dayPicker.value = state.ui?.selectedDay || todayISO()
updateTodayLabel()
renderHome()

// Events
els.dayPicker.addEventListener('change', ()=>{ state.ui.selectedDay = els.dayPicker.value; save(); renderHome(); })
els.resetDay.addEventListener('click', ()=>{ els.dayPicker.value=todayISO(); state.ui.selectedDay=els.dayPicker.value; save(); renderHome();})
els.navHome.addEventListener('click', ()=>{gotoHome()})
els.navHistory.addEventListener('click', ()=>{
  // history is simply: stay on home but change date via prompt (for prototype)
  const d = prompt('Date (YYYY-MM-DD)', els.dayPicker.value)
  if(d){ els.dayPicker.value = d; state.ui.selectedDay=d; save(); renderHome(); }
})
els.backBtn.addEventListener('click', ()=>{gotoHome()})
els.addBtn.addEventListener('click', ()=> openAddDialog())
els.closeDialog.addEventListener('click', ()=> els.taskDialog.close())
els.f_recur.addEventListener('change', onRecurChange)

els.saveTask.addEventListener('click', (e)=>{
  e.preventDefault()
  const cat = state.ui.currentCat
  const title = els.f_title.value.trim()
  if(!title) return
  const emoji = els.f_emoji.value || 'ğŸ¯'
  const importance = els.f_importance.value
  const r = els.f_recur.value
  const recur = r==='daily' ? {type:'daily'} : r==='weekly' ? {type:'weekly', weekday:+els.f_weekday.value} : {type:'everyX', interval:Math.max(2, +els.f_everyX.value||3), anchor: todayISO()}
  state.tasks.push({id:uid(), cat, title, emoji, importance, recur, createdAt:todayISO()})
  save(); els.taskDialog.close(); openCategory(cat)
})

function onRecurChange(){
  const v = els.f_recur.value
  els.recurWeeklyWrap.style.display = v==='weekly' ? 'block' : 'none'
  els.recurEveryXWrap.style.display = v==='everyX' ? 'block' : 'none'
}

function gotoHome(){
  els.home.classList.add('active'); els.category.classList.remove('active')
  state.ui.currentCat = null; save(); renderHome()
}

function openCategory(cat){
  state.ui.currentCat = cat; save()
  els.home.classList.remove('active'); els.category.classList.add('active')
  els.catTitle.textContent = categoryLabel(cat)
  renderTasks(cat)
}

function openAddDialog(){
  if(!state.ui.currentCat) return
  els.f_title.value=''; els.f_emoji.value=''; els.f_importance.value='must'; els.f_recur.value='daily'; onRecurChange();
  els.taskDialog.showModal()
}

function renderHome(){
  updateTodayLabel()
  const day = els.dayPicker.value
  const dueToday = state.tasks.filter(t=>isDue(t, day))
  const doneToday = dueToday.filter(t=>isDone(t, day))
  const pct = dueToday.length? Math.round(doneToday.length*100/dueToday.length):100
  els.progress.style.setProperty('--p', pct)
  els.pct.textContent = pct+"%"
  els.sumLine.textContent = `${doneToday.length}/${dueToday.length} tÃ¢ches faites`

  // grid
  els.catGrid.innerHTML=''
  for(const c of CATS){
    const tasks = state.tasks.filter(t=>t.cat===c.id && isDue(t, day))
    const done = tasks.filter(t=>isDone(t, day))
    const remaining = tasks.filter(t=>!isDone(t, day))
    const status = tasks.length===0 || remaining.length===0 ? 'green' : (remaining.some(t=>t.importance==='must') ? 'red' : 'yellow')
    const card=document.createElement('button')
    card.className='card'
    card.dataset.status=status
    card.style.borderColor = status==='green'? 'var(--ok)': status==='yellow'? 'var(--warn)':'var(--bad)'
    card.innerHTML = `
      <div class="card-head">
        <div class="dot" style="background:${c.color}"></div>
        <h3>${categoryLabel(c.id)}</h3>
        <span class="status">${status==='green'?'âœ… OK': status==='yellow'?'ğŸŸ¨ Conseils':'ğŸŸ¥ Ã€ faire'}</span>
      </div>
      <div class="count">${done.length}/${tasks.length} aujourd'hui</div>
      <div class="emoji-row">${remaining.map(t=>`<span class='emoji' title="${escapeHtml(t.title)}">${t.emoji}</span>`).join('') || '<span class="count">Rien Ã  faire ğŸ‰</span>'}</div>
    `
    card.addEventListener('click', ()=> openCategory(c.id))
    els.catGrid.appendChild(card)
  }
}

function renderTasks(cat){
  const day = els.dayPicker.value
  const arr = state.tasks.filter(t=>t.cat===cat && isDue(t, day))
  arr.sort((a,b)=> (isDone(a,day)-isDone(b,day)) || (a.importance>b.importance?1:-1))
  els.taskList.innerHTML=''
  if(arr.length===0){
    els.taskList.innerHTML = `<div class="count">Aucune tÃ¢che due ce jour. Ajoute-en avec Â« + Â».</div>`
    return
  }
  for(const t of arr){
    const row=document.createElement('div')
    row.className='task'+(isDone(t,day)?' done':'')
    row.style.borderLeft=`4px solid ${catColor(t.cat)}`
    row.innerHTML=`<div class="swipe-hint"></div>
      <span class="em">${t.emoji}</span>
      <div>
        <div class="title">${escapeHtml(t.title)}</div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <span class="badge">${t.importance==='must'?'Obligatoire':'ConseillÃ©'}</span>
          <span class="badge">${recurLabel(t.recur)}</span>
        </div>
      </div>
      <div class="line">
        <button class="icon-btn" data-act="toggle">${isDone(t,day)?'â†©ï¸ Annuler':'âœ”ï¸ Fait'}</button>
      </div>`

    // click toggle
    row.querySelector('[data-act=toggle]').addEventListener('click', ()=>{ toggleDone(t, day); row.classList.toggle('done'); renderTasks(cat); renderHome(); })

    // swipe to complete
    let startX=0, swiping=false
    row.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; swiping=false })
    row.addEventListener('touchmove', e=>{
      const dx = e.touches[0].clientX-startX
      if(dx>8){ swiping=true; row.classList.add('swiping'); row.style.transform=`translateX(${Math.min(dx,80)}px)` }
    })
    row.addEventListener('touchend', ()=>{
      row.classList.remove('swiping')
      if(parseInt(row.style.transform.replace(/[^0-9-]/g,''))>60){ toggleDone(t, day); renderTasks(cat); renderHome(); }
      row.style.transform='translateX(0)'
    })

    els.taskList.appendChild(row)
  }
}

// Helpers
function recurLabel(r){
  if(r.type==='daily') return 'Quotidien'
  if(r.type==='weekly') return 'Chaque '+ ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][r.weekday]
  if(r.type==='everyX') return `Tous les ${r.interval} j`
}
function categoryLabel(id){ return id }
function catColor(id){ const c=CATS.find(x=>x.id===id); return c?c.color:'#fff'}

function isDue(task, ymd){
  const d = new Date(ymd +'T00:00:00')
  const w = d.getDay()
  if(task.recur.type==='daily') return true
  if(task.recur.type==='weekly') return w===(+task.recur.weekday||1)
  if(task.recur.type==='everyX'){
    const anchor = new Date((task.recur.anchor||task.createdAt)+'T00:00:00')
    const diff = Math.floor((d - anchor)/86400000)
    return diff>=0 && diff % (task.recur.interval||3)===0
  }
  return false
}

function isDone(task, ymd){ return !!(state.done[ymd] && state.done[ymd][task.id]) }
function toggleDone(task, ymd){
  state.done[ymd] = state.done[ymd] || {}
  state.done[ymd][task.id] = !isDone(task, ymd)
  save()
}

function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)) }
function load(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)) }catch(e){return null}}

function seed(){
  const today = todayISO()
  const mk=(cat,title,emoji,importance,recur)=>({id:uid(),cat,title,emoji,importance,recur,createdAt:today})
  const S=[]
  // Nutrition
  S.push(mk('Nutrition','Petit-dÃ©j. protÃ©inÃ©','ğŸ³','must',{type:'daily'}))
  S.push(mk('Nutrition','2 fruits','ğŸ','nice',{type:'daily'}))
  S.push(mk('Nutrition','Hydratation 1,5L','ğŸ’§','must',{type:'daily'}))
  S.push(mk('Nutrition','Poisson','ğŸŸ','nice',{type:'weekly',weekday:5}))
  S.push(mk('Nutrition','LÃ©gumineuses','ğŸ«˜','nice',{type:'everyX',interval:3,anchor:today}))
  // HygiÃ¨ne
  S.push(mk('HygiÃ¨ne','Brossage matin','ğŸª¥','must',{type:'daily'}))
  S.push(mk('HygiÃ¨ne','Brossage soir','ğŸª¥','must',{type:'daily'}))
  S.push(mk('HygiÃ¨ne','Douche tiÃ¨de','ğŸš¿','nice',{type:'daily'}))
  S.push(mk('HygiÃ¨ne','Changer serviette','ğŸ§º','weekly',{type:'weekly',weekday:0}))
  S.push(mk('HygiÃ¨ne','Nettoyer visage','ğŸ§´','nice',{type:'everyX',interval:2,anchor:today}))
  // Exercice
  S.push(mk('Exercice','Marche 30 min','ğŸš¶','nice',{type:'daily'}))
  S.push(mk('Exercice','Renfo 15 min','ğŸ’ª','must',{type:'everyX',interval:2,anchor:today}))
  S.push(mk('Exercice','Ã‰tirements','ğŸ§˜','nice',{type:'daily'}))
  S.push(mk('Exercice','VÃ©lo','ğŸš²','nice',{type:'weekly',weekday:6}))
  S.push(mk('Exercice','Bachata practice','ğŸ’ƒ','must',{type:'weekly',weekday:3}))
  // Sommeil
  S.push(mk('Sommeil','Coucher < 23h','ğŸ›ï¸','must',{type:'daily'}))
  S.push(mk('Sommeil','Ã‰cran off 1h avant','ğŸ“µ','nice',{type:'daily'}))
  S.push(mk('Sommeil','Sieste 20 min','ğŸ˜´','nice',{type:'everyX',interval:3,anchor:today}))
  S.push(mk('Sommeil','AÃ©ration chambre','ğŸªŸ','nice',{type:'daily'}))
  S.push(mk('Sommeil','Rituel zen','ğŸ•¯ï¸','nice',{type:'weekly',weekday:5}))
  // Social
  S.push(mk('Social','Message Ã  un ami','ğŸ’¬','nice',{type:'everyX',interval:2,anchor:today}))
  S.push(mk('Social','CafÃ©/ThÃ© avec quelquâ€™un','â˜•','nice',{type:'weekly',weekday:2}))
  S.push(mk('Social','Danse sociale','ğŸ•º','must',{type:'weekly',weekday:5}))
  S.push(mk('Social','Appel famille','ğŸ“','must',{type:'weekly',weekday:0}))
  S.push(mk('Social','Compliment sincÃ¨re','ğŸ¤','nice',{type:'daily'}))
  // Autre
  S.push(mk('Autre','Lecture 10 min','ğŸ“š','nice',{type:'daily'}))
  S.push(mk('Autre','Journal 3 lignes','ğŸ“','nice',{type:'daily'}))
  S.push(mk('Autre','TÃ¢che admin','ğŸ—‚ï¸','must',{type:'everyX',interval:4,anchor:today}))
  S.push(mk('Autre','Sortie nature','ğŸŒ³','nice',{type:'weekly',weekday:6}))
  S.push(mk('Autre','MÃ©ditation 5 min','ğŸ§˜â€â™‚ï¸','nice',{type:'daily'}))

  return {tasks:S, done:{}, ui:{selectedDay:today, currentCat:null}}
}

function updateTodayLabel(){
  const isToday = els.dayPicker.value===todayISO()
  els.todayLabel.textContent = isToday? "Aujourd'hui" : "SÃ©lection"
}

function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

// Open category from grid
els.catGrid.addEventListener('click', (e)=>{
  const card = e.target.closest('.card'); if(!card) return
})

// Deep link support (?cat=)
const qp=new URLSearchParams(location.search)
if(qp.get('cat')){ openCategory(qp.get('cat')) }

</script>
</body>
</html>
