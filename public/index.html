<!doctype html><html lang="fr"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><title>Habitu.be ‚Äî Prototype (simplifi√©)</title>
<style>
:root{--bg:#f7f3ea;--card:#fffdf8;--text:#1e1f1a;--green:#2a7a57;--border:#c6beae;--r:4px;--gap:8px;--fs:13px}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font:400 var(--fs)/1.35 system-ui,-apple-system,Roboto,sans-serif;color:var(--text);background:var(--bg)}
#app{max-width:480px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;position:relative}
button,.select,.tab,.stab,.btn,.btnToggle,.navbtn,.calBtn,.backMini{font:600 13px/1.2 system-ui,-apple-system,Roboto,sans-serif;padding:6px 10px;border-radius:var(--r);cursor:pointer;border:1px solid var(--border);background:var(--card)}
.btn.primary{background:var(--green);color:#fff;border-color:transparent}.btn.danger{border-color:#d99;color:#600;background:#fff5f5}
.btnToggle.active,.tab.active,.stab.active{outline:2px solid var(--green)}.select{appearance:none}
.top{position:sticky;top:0;background:var(--bg);z-index:6;border-bottom:1px solid var(--border);padding:6px var(--gap);display:flex;align-items:center;gap:8px}
.brand{font-weight:800;cursor:pointer;display:flex;align-items:center;gap:6px}.brand .logo{font-size:18px}.spacer{flex:1}
.daysWrap{position:sticky;top:44px;background:var(--bg);z-index:5;border-bottom:1px solid var(--border);padding:6px var(--gap);display:flex;align-items:center;gap:6px;justify-content:space-between}
.rightBtns{display:flex;flex-direction:row;gap:6px;align-items:flex-end}
.dateLabel,.todayCount{font-weight:700;padding:0;border:none;background:transparent}
.list{padding:var(--gap);display:grid;grid-template-columns:1fr;gap:var(--gap);position:relative;z-index:1}
.card{border:1px solid var(--border);background:var(--bg);border-radius:var(--r);display:grid;grid-template-columns:64px 1fr;overflow:hidden}
.card.done{border:2px solid var(--green)}
.content{padding:4px;display:flex;flex-direction:column;gap:4px}
.title{font-weight:700;display:flex;align-items:center;gap:4px;font-size:14px;min-height:22px;justify-content:space-between}
.title .left{display:flex;align-items:center;gap:4px}
.title .hint{font-size:10px;color:#8f8f8c;font-weight:600}
.title .base.strike{text-decoration:line-through;opacity:.75}
.editPen{background-color:transparent;border-color:var(--border);padding:4px;}
.desc{font-size:11px;color:#8f8f8c;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;cursor:default}
.desc.open{-webkit-line-clamp:unset;display:block;white-space:pre-line;overflow:visible}
.desc.hidden{display:none}
.friends{margin-top:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.badge{display:flex;align-items:center;gap:6px;padding:4px 6px;border:1px solid var(--border);border-radius:var(--r);background:#fff;font-size:11px;line-height:1.2}
.levelCol{padding:0 6px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.levelBtn{width:100%;height:60px;border-radius:var(--r);border:1px solid var(--border);background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;line-height:1.05;position:relative}
.levelBtn .big{position:absolute;top:4px;left:0;right:0;text-align:center;font-size:22px;font-weight:800}
.levelBtn .scoreText{position:absolute;bottom:2px;left:4px;right:4px;text-align:center;font-size:12px;font-weight:800;line-height:1}
.section{padding:var(--gap)}
.detailHead{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:5;background:var(--bg);padding:6px var(--gap);border-bottom:1px solid var(--border)}
.detailTitle{font-weight:800;font-size:16px}
.tabs{display:flex;gap:6px;padding:var(--gap);border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:80px;z-index:4}
.tab{flex:1;text-align:center}.view{display:none}.view.active{display:block}
.rankHeader{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
.rank{display:grid;gap:8px;margin-top:8px}
.row{display:flex;justify-content:space-between;align-items:center;padding:6px;border:1px solid var(--border);background:var(--bg);border-radius:var(--r)}
.leftRank{display:flex;align-items:center;gap:8px}
.likeBtn{min-width:74px;text-align:center}
.scoreEmoji{font-size:18px;font-weight:900;margin-left:4px;white-space:pre-line}
.calendarWrap{padding:0 var(--gap) var(--gap)}
.calTop{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{height:55px;display:grid;place-items:center;border:1px dashed var(--border);background:var(--card);border-radius:var(--r);position:relative;overflow:hidden;cursor:pointer}
.dayNum{position:absolute;top:4px;right:6px;font-size:10px;color:#777}
.seedMark{position:absolute;top:18px;left:0;right:0;text-align:center;font-size:14px;line-height:1;font-weight:700}
.cell .dur{position:absolute;bottom:2px;left:4px;right:4px;text-align:center;font:800 12px/1 system-ui}
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.2);padding:0;z-index:10}
.modal.on{display:flex;align-items:stretch;justify-content:stretch}
.sheet{position:absolute;inset:0;background:var(--card)}
.sheetHeader{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px var(--gap);border-bottom:1px solid var(--border);background:var(--bg)}
.sheetBody{padding:var(--gap);height:calc(100% - 50px);overflow:auto;background:var(--bg)}
.grid{display:grid;gap:8px}
.opt{border:1px solid var(--border);background:var(--card);border-radius:var(--r);padding:12px;display:flex;gap:8px;align-items:center;cursor:pointer}
.opt .emoji{font-size:20px}
.field{display:grid;gap:4px}
input[type="text"],textarea,select{padding:10px;border:1px solid var(--border);border-radius:var(--r);background:#fffdf8;font-size:13px}
.inputEmoji{position:relative;display:flex;align-items:center}
.inputEmoji .emojiPrefix{position:absolute;left:10px;font-size:20px;pointer-events:none;line-height:1}
.inputEmoji input{width:100%;padding-left:42px}
textarea.editing{background:#fff;border:1px solid var(--border)}
.stabs{display:flex;gap:6px;padding:6px;position:sticky;top:52px;background:var(--bg);border-bottom:1px solid var(--border);z-index:2}
.stab{flex:1;text-align:center}
.sview{display:none}.sview.active{display:block}
.rowInline{display:flex;gap:8px;align-items:center}.rowInline input{flex:1}.rowInline .btn.copyOnly{padding:6px 10px}
.miniInfo{font-size:12px;color:#555}
.hide{display:none}
</style></head><body>
<div id="app">
  <div class="top">
    <div class="brand" id="brand"><span class="logo">üå±</span>Habitu.be</div>
    <div class="spacer"></div>
    <select id="spaceSel" class="select" title="Changer de jardin"></select>
    <button class="navbtn" id="openSpace" title="Jardin">‚ìò</button>
  </div>

  <div class="daysWrap" id="daysWrap">
    <button class="navbtn" id="prevDay">‚Üê</button>
    <div style="display:flex;align-items:center;gap:6px">
      <div class="dateLabel" id="dateLabel">‚Äî</div>
      <div class="todayCount" id="todayCount">0h00</div>
    </div>
    <div class="rightBtns">
      <button class="navbtn" id="nextDay">‚Üí</button>
      <button class="navbtn" id="addBtn" title="Ajouter">Ôºã</button>
    </div>
  </div>

  <main id="home" class="view active"><div class="list" id="cards"></div></main>

  <section id="detail" class="view">
    <div class="detailHead">
      <button class="backMini" id="backHome">‚Üê</button>
      <div class="detailTitle" id="detailTitle"></div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="members">üë®‚Äçüåæ Jardiniers</button>
      <button class="tab" data-tab="history">üìÖ Historique</button>
      <button class="tab" data-tab="settings">‚úèÔ∏è √âdition</button>
    </div>
    <div class="section">
      <div class="view active" id="tab-members">
        <div class="rankHeader">
          <b>Dur√©e</b>
          <div style="font-size:12px;display:flex;gap:8px;align-items:center">
            P√©riode:
            <div style="display:flex;gap:8px">
              <button class="btnToggle" data-period="7" id="btnP7">7 jours</button>
              <button class="btnToggle active" data-period="30" id="btnP30">30 jours</button>
              <button class="btnToggle" data-period="all" id="btnPAll">Total</button>
            </div>
          </div>
        </div>
        <div class="rank" id="rank"></div>
      </div>
      <div class="view" id="tab-history">
        <div class="calendarWrap">
          <div class="calTop">
            <div style="display:flex;gap:6px;align-items:center">
              <button class="calBtn" id="prevMonth">‚Üê</button>
              <div id="monthLabel" style="font-weight:700"></div>
              <button class="calBtn" id="nextMonth">‚Üí</button>
            </div>
            <div id="calWhoWrap" style="display:flex;gap:6px;align-items:center">
              <span style="font-size:12px">Voir :</span>
              <select id="calWho" class="select" style="padding:6px"></select>
            </div>
          </div>
          <div class="calendar" id="cal"></div>
        </div>
      </div>

      <div class="view" id="tab-settings">
        <div class="grid">
          <div class="field">
            <label><b>Nom personnalis√©</b></label>
            <div class="inputEmoji">
              <span class="emojiPrefix" id="habitTitleEmoji">üå±</span>
              <input id="habitTitleInput" type="text" placeholder="Nom de l'habitude"/>
            </div>
          </div>

          <div class="field">
            <label><b>Description</b></label>
            <textarea id="habitDesc" placeholder="D√©cris ton habitude (objectif, contexte, tips). Clique pour √©diter."></textarea>
          </div>

          <div class="field">
            <label><b>Fr√©quence</b></label>
            <div class="grid" style="gap:6px">
              <select id="freqType" class="select">
                <option value="quotidien">Quotidien</option>
                <option value="tousx">Tous les X jours</option>
                <option value="hebdo">Hebdomadaire</option>
                <option value="ponctuelle">Ponctuelle</option>
                <option value="jours">Jour(s) de la semaine</option>
              </select>
              <div id="freqSubTousx" class="rowInline"><span>X=</span><select id="freqX" class="select"><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
              <div id="freqSubPonctuelle" class="rowInline hide"><span>Date</span><input id="freqDate" type="text" placeholder="JJ/MM/AAAA"/></div>
              <div id="freqSubJours" class="hide" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px">
                <label><input type="checkbox" value="1">Lu</label>
                <label><input type="checkbox" value="2">Ma</label>
                <label><input type="checkbox" value="3">Me</label>
                <label><input type="checkbox" value="4">Je</label>
                <label><input type="checkbox" value="5">Ve</label>
                <label><input type="checkbox" value="6">Sa</label>
                <label><input type="checkbox" value="0">Di</label>
              </div>
            </div>
          </div>

          <div class="field"><label><b>Dur√©e par d√©faut</b></label><select id="mockDefaultDur" class="select"><option>15 min</option><option>30 min</option><option>45 min</option><option>60 min</option></select></div>

          <div class="field">
            <label><b>Mode de r√©alisation</b></label>
            <div class="rowInline">
              <select id="modeSelect" class="select">
                <option value="libre">Libre</option>
                <option value="commun">Commun</option>
              </select>
              <select id="modeN" class="select hide" title="Nombre requis"> <!-- masqu√© (plus de Partag√©) -->
                <option value="2">√ó2</option><option value="3">√ó3</option><option value="4">√ó4</option>
              </select>
            </div>
            <div class="miniInfo">Libre (toi) ¬∑ Commun (1 personne). Le mode ‚ÄúPartag√©‚Äù est retir√©.</div>
          </div>

          <div class="field"><label><b>Rappel (mock)</b></label><select class="select"><option>Aucun</option><option>9:00</option><option>12:30</option><option>20:00</option></select></div>

          <div style="margin-top:14px"><button class="btn danger" id="deleteHabitBtn">Supprimer</button></div>
        </div>
      </div>
    </div>
  </section>

  <section id="space" class="view">
    <div class="detailHead">
      <button class="backMini" id="backFromSpace">‚Üê</button>
      <div class="detailTitle" id="spaceHeaderTitle"></div>
      <div class="spacer"></div>
      <button class="btn" id="spaceAccountBtn">üë§ Mon compte</button>
    </div>
    <div class="tabs">
      <button class="tab active" data-stab="sprofile">üë®‚Äçüåæ Jardiniers</button>
      <button class="tab" data-stab="shistory">üìÖ Historique</button>
      <button class="tab" data-stab="sparams">‚úèÔ∏è √âdition</button>
    </div>
    <div class="section">
      <div class="view active" id="sprofile">
        <div class="rankHeader">
          <b>Dur√©e</b>
          <div style="font-size:12px;display:flex;gap:8px;align-items:center">
            P√©riode:
            <div style="display:flex;gap:8px">
              <button class="btnToggle" data-speriod="7" id="sBtnP7">7 jours</button>
              <button class="btnToggle active" data-speriod="30" id="sBtnP30">30 jours</button>
              <button class="btnToggle" data-speriod="all" id="sBtnPAll">Total</button>
            </div>
          </div>
        </div>
        <div class="rank" id="spaceRank"></div>
      </div>
      <div class="view" id="shistory">
        <div class="calendarWrap">
          <div class="calTop">
            <div style="display:flex;gap:6px;align-items:center">
              <button class="calBtn" id="sPrevMonth">‚Üê</button>
              <div id="sMonthLabel" style="font-weight:700"></div>
              <button class="calBtn" id="sNextMonth">‚Üí</button>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <span style="font-size:12px">Voir :</span>
              <select id="sCalWho" class="select" style="padding:6px"></select>
            </div>
          </div>
          <div class="calendar" id="sCal"></div>
        </div>
      </div>
      <div class="view" id="sparams">
        <div class="grid">
          <div class="field">
            <label><b>Description</b></label>
            <textarea id="spaceDescInfo" placeholder="Pr√©sentez le jardin, les r√®gles et l‚Äô√©tat d‚Äôesprit. Cliquez pour √©diter."></textarea>
          </div>
          <div class="field"><label><b>Mon pseudo</b></label><input id="paramName" type="text" value="Moi"/></div>
          <div class="field"><label><b>Nom du jardin</b></label><input id="paramSpaceLabel" type="text"/></div>
          <div class="field"><label><b>Acc√®s</b></label><select class="select"><option>Public</option><option>Sur invitation</option></select></div>
          <div class="field"><label><b>Droits d'√©dition</b></label><select class="select"><option>Admin</option><option>Tous</option></select></div>
          <div style="margin-top:12px"><button class="btn danger" id="quitSpaceBtn">Quitter le jardin</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Ajouter -->
  <div class="modal" id="modalAdd">
    <div class="sheet">
      <div class="sheetHeader"><div id="modalTitle">Ajouter</div><button class="closeX" id="closeAdd">‚®â</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="opt" id="addHabit"><div class="emoji">üå±</div><div><b>Nouvelle habitude</b><div class="subtitle">Rejoindre un d√©fi</div></div></div>
          <div class="opt hide" id="addPrivateHabit"><div class="emoji">‚ú®</div><div><b>Nouvelle habitude priv√©e</b><div class="subtitle">Enti√®rement personnalisable</div></div></div>
          <div class="opt" id="inviteFriend"><div class="emoji">üåû</div><div><b>Inviter un jardinier</b><div class="subtitle">Lien √† partager</div></div></div>
          <div class="opt" id="joinSpace"><div class="emoji">ü§ù</div><div><b>Rejoindre un jardin</b><div class="subtitle">Entrer un code</div></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inviter -->
  <div class="modal" id="modalInvite">
    <div class="sheet">
      <div class="sheetHeader"><div>Inviter</div><button class="closeX" id="closeInvite">‚®â</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="field">
            <label><b>Lien √† partager</b></label>
            <div class="rowInline"><input id="inviteLink" type="text" readonly/><button class="btn copyOnly" id="copyInvite" title="Copier">üîó</button></div>
            <div class="subtitle">Le lien contient le code de ton jardin.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Habitude (wizard mini) -->
  <div class="modal" id="modalHabit">
    <div class="sheet">
      <div class="sheetHeader"><div id="habitTitle">Nouvelle habitude</div><button class="closeX" id="closeHabit">‚®â</button></div>
      <div class="sheetBody"><div class="grid" id="step1"></div><div class="grid" id="step2" style="display:none"></div></div>
    </div>
  </div>

  <!-- Espace -->
  <div class="modal" id="modalSpace">
    <div class="sheet">
      <div class="sheetHeader"><div>Cr√©er / Rejoindre un jardin</div><button class="closeX" id="closeSpace">‚®â</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="field"><label><b>Code (6 caract√®res alphanum√©riques)</b></label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="spaceCode" type="text" placeholder="ABC123" maxlength="6" style="text-transform:uppercase"/>
              <button class="btn" id="spaceGen">Cr√©er</button>
            </div>
          </div>
          <div class="field"><label><b>Ton pr√©nom</b></label><input id="spaceName" type="text" placeholder="Pr√©nom"/></div>
          <div class="grid" style="grid-template-columns:1fr 1fr"><button class="btn" id="spaceCancel">Annuler</button><button class="btn primary" id="spaceSave">Rejoindre</button></div>
          <div class="subtitle">Prototype : entre le code & ton pr√©nom, puis choisis le type de profil.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Wizard profil -->
  <div class="modal" id="modalWizard">
    <div class="sheet">
      <div class="sheetHeader"><div id="wizTitle">Type de profil</div><button class="closeX" id="closeWizard">‚®â</button></div>
      <div class="sheetBody"><div class="grid" id="wizStep"></div></div>
    </div>
  </div>
</div>

<script>
/* ===== Donn√©es ===== */

// Habitudes r√©currentes ‚Äî VIE MAT√âRIELLE EN COMMUNAUT√â (only)
// √Ä coller √† la place des listes pr√©c√©dentes

const CHALLENGES = [
  {type:'private',id:'screenoff',cat:'sante',emoji:'üõå',titre:'Sans √©cran avant le coucher',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'private',id:'repas',cat:'sante',emoji:'ü•ó',titre:'Repas sain fait maison',amis:['Ben','Duc']},
  {type:'private',id:'lire',cat:'esprit',emoji:'üìñ',titre:'Lire un livre ou un roman',amis:['Chlo√©']},
  {type:'private',id:'etire',cat:'corps',emoji:'ü§∏',titre:'√âtirements corporels',amis:['Anna','Nicolas']},
  {type:'private',id:'ranger',cat:'vie',emoji:'üßΩ',titre:'Rangement ou m√©nage',amis:['Chlo√©']},
  {type:'private',id:'creer',cat:'loisirs',emoji:'üé∏',titre:'Cr√©er ou jouer',amis:['Ben','Pauline']},
  {type:'private',id:'respirer',cat:'repos',emoji:'üå¨Ô∏è',titre:'Respiration coh√©rence cardiaque',amis:['Anna','Marie']},
  /* +12 Individu (bien-√™tre & quotidien) */
  {type:'private',id:'hydratation_quot',cat:'sante',emoji:'üíß',titre:'Boire 6‚Äì8 verres d‚Äôeau',amis:['Moi']},
  {type:'private',id:'marche_20',cat:'corps',emoji:'üö∂',titre:'Marche active 20 min',amis:['Moi','Ben']},
  {type:'private',id:'dos_gainage',cat:'corps',emoji:'üß±',titre:'Gainage 3√ó30s',amis:['Moi','Anna']},
  {type:'private',id:'plan_repas',cat:'vie',emoji:'üßæ',titre:'Planifier les repas',amis:['Moi','Chlo√©']},
  {type:'private',id:'inbox_zero_perso',cat:'esprit',emoji:'üì¨',titre:'Inbox z√©ro perso (10 min)',amis:['Moi']},
  {type:'private',id:'budget_flash',cat:'esprit',emoji:'üí∂',titre:'Budget flash (5 lignes)',amis:['Moi']},
  {type:'private',id:'mediter_10',cat:'repos',emoji:'üßò',titre:'M√©diter 10 min',amis:['Moi','Marie']},
  {type:'private',id:'etire_cervicales',cat:'corps',emoji:'ü¶¥',titre:'√âtirements nuque/√©paules',amis:['Moi']},
  {type:'private',id:'lecture_tech',cat:'esprit',emoji:'üß©',titre:'Lire 10 pages utile',amis:['Moi']},
  {type:'private',id:'lessive_personnelle',cat:'vie',emoji:'üß∫',titre:'Lancer sa lessive',amis:['Moi']},
  {type:'private',id:'sortir_dehors',cat:'loisirs',emoji:'üå§Ô∏è',titre:'10 min de lumi√®re naturelle',amis:['Moi']},
  {type:'private',id:'gratitude_3',cat:'esprit',emoji:'‚ú®',titre:'√âcrire 3 gratitudes',amis:['Moi']}
];

const GROUP_CHALLENGES = [
  // üè† COLOCATION ‚Äî op√©rations & intendance
  {type:'group',id:'coloc_courses',cat:'coloc',emoji:'üõí',titre:'Courses communes faites',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_frigo_tri',cat:'coloc',emoji:'ü•∂',titre:'Frigo tri√© + dates v√©rifi√©es',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_lv_range',cat:'coloc',emoji:'üçΩÔ∏è',titre:'Lave-vaisselle vid√© & rang√©',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_plan_menage',cat:'coloc',emoji:'üóÇÔ∏è',titre:'Planning m√©nage √† jour',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_sol',cat:'coloc',emoji:'üßπ',titre:'Aspiration + serpill√®re',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_sdb_wc',cat:'coloc',emoji:'üöø',titre:'SDB & WC nettoy√©s',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_poubelles',cat:'coloc',emoji:'üóëÔ∏è',titre:'Poubelles & tri sortis',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_stock_hygiene',cat:'coloc',emoji:'üßª',titre:'Stocks (papier, savon) OK',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_plantes',cat:'coloc',emoji:'ü™¥',titre:'Arrosage des plantes',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_entree',cat:'coloc',emoji:'üö™',titre:'Entr√©e d√©gag√©e & propre',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_energie',cat:'coloc',emoji:'üîå',titre:'Veilles √©teintes / conso',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']},
  {type:'group',id:'coloc_machine',cat:'coloc',emoji:'üßº',titre:'Machine d√©tartr√©e / filtre',amis:['Anna','Ben','Chlo√©','Nicolas','Marie']}
];

const FAMILY_CHALLENGES = [
  // üë®‚Äçüë©‚Äçüëß‚Äçüë¶ FAMILLE ‚Äî logistique du foyer
  {type:'group',id:'fam_courses',cat:'famille',emoji:'üõí',titre:'Courses familiales faites',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_menus',cat:'famille',emoji:'üç≤',titre:'Menus & liste planifi√©s',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_linge',cat:'famille',emoji:'üëï',titre:'Linge lav√©, s√©ch√©, pli√©',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_lave_vaisselle',cat:'famille',emoji:'üçΩÔ∏è',titre:'LV vid√© & cuisine rang√©e',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_nettoyage',cat:'famille',emoji:'üßΩ',titre:'Surfaces & sols',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_poubelles',cat:'famille',emoji:'‚ôªÔ∏è',titre:'Tri & poubelles sorties',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_stock',cat:'famille',emoji:'üì¶',titre:'Stocks (alimentaire/hygi√®ne)',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_rangement',cat:'famille',emoji:'üß∫',titre:'Pi√®ces communes rang√©es',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_entretien',cat:'famille',emoji:'üõ†Ô∏è',titre:'Petites r√©parations faites',amis:['Maman','Papa','David','Jonas']},
  {type:'group',id:'fam_securite',cat:'famille',emoji:'üßØ',titre:'D√©tecteurs & trousse OK',amis:['Maman','Papa','David','Jonas']}
];

const ASSOCIATION_CHALLENGES = [
  // ü§ù ASSOCIATION ‚Äî intendance de lieu & √©v√©nements
  {type:'group',id:'asso_salle',cat:'asso',emoji:'üèüÔ∏è',titre:'Salle pr√™te (chaises, sono)',amis:['Alice','Bruno','Camille','Dina']},
  {type:'group',id:'asso_stock',cat:'asso',emoji:'üì¶',titre:'Inventaire & r√©assort',amis:['Alice','Bruno','Camille','Dina']},
  {type:'group',id:'asso_buvette',cat:'asso',emoji:'ü•§',titre:'Buvette & caisse pr√™ts',amis:['Alice','Bruno','Camille','Dina']},
  {type:'group',id:'asso_proprete',cat:'asso',emoji:'üßΩ',titre:'Nettoyage avant/apr√®s',amis:['Alice','Bruno','Camille','Dina']},
  {type:'group',id:'asso_affichages',cat:'asso',emoji:'üìã',titre:'Affichages & signal√©tique',amis:['Alice','Bruno','Camille','Dina']},
  {type:'group',id:'asso_matos',cat:'asso',emoji:'üß∞',titre:'Mat√©riel v√©rifi√©/charg√©',amis:['Alice','Bruno','Camille','Dina']},
  {type:'group',id:'asso_dechets',cat:'asso',emoji:'üóëÔ∏è',titre:'D√©chets tri√©s & sortis',amis:['Alice','Bruno','Camille','Dina']},
  {type:'group',id:'asso_clefs',cat:'asso',emoji:'üîë',titre:'Cl√©s & acc√®s g√©r√©s',amis:['Alice','Bruno','Camille','Dina']},
  {type:'group',id:'asso_securite',cat:'asso',emoji:'ü¶∫',titre:'S√©curit√© : extincteurs/issue',amis:['Alice','Bruno','Camille','Dina']}
];

const OFFICE_CHALLENGES = [
  // üßë‚Äçüíº BUREAU ‚Äî logistique & maintenance courante
  {type:'group',id:'bureau_postes',cat:'bureau',emoji:'üßΩ',titre:'Bureaux & open-space rang√©s',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'bureau_salle_reu',cat:'bureau',emoji:'üè∑Ô∏è',titre:'Salle de r√©union pr√™te',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'bureau_kitchenette',cat:'bureau',emoji:'üçµ',titre:'Coin caf√©/vaisselle OK',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'bureau_consommables',cat:'bureau',emoji:'üñ®Ô∏è',titre:'Papier/toner/lingettes OK',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'bureau_dechets',cat:'bureau',emoji:'‚ôªÔ∏è',titre:'Tri & bennes vid√©es',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'bureau_nettoyage',cat:'bureau',emoji:'üßπ',titre:'Sol & surfaces faits',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'bureau_stock_it',cat:'bureau',emoji:'üíæ',titre:'Stock IT (c√¢bles, adapt.)',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'bureau_plantes',cat:'bureau',emoji:'ü™¥',titre:'Plantes arros√©es',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'bureau_securite',cat:'bureau',emoji:'üßØ',titre:'Affichages & trousse OK',amis:['Alice','Bob','Carla','Dan']}
];

// (Optionnel) CLASSE si tu g√®res un lieu scolaire
const CLASS_CHALLENGES = [
  {type:'group',id:'classe_materiel',cat:'classe',emoji:'üß∞',titre:'Mat√©riel rang√© & complet',amis:['M. Dupont','Emma','Lucas','Lucie','Yanis','Clara']},
  {type:'group',id:'classe_proprete',cat:'classe',emoji:'üßπ',titre:'Sol & tableau propres',amis:['M. Dupont','Emma','Lucas','Lucie','Yanis','Clara']},
  {type:'group',id:'classe_consos',cat:'classe',emoji:'‚úèÔ∏è',titre:'Consommables (craie/feutres)',amis:['M. Dupont','Emma','Lucas','Lucie','Yanis','Clara']},
  {type:'group',id:'classe_affichages',cat:'classe',emoji:'üìú',titre:'Affiches & consignes √† jour',amis:['M. Dupont','Emma','Lucas','Lucie','Yanis','Clara']},
  {type:'group',id:'classe_tri',cat:'classe',emoji:'‚ôªÔ∏è',titre:'Tri & poubelles sorties',amis:['M. Dupont','Emma','Lucas','Lucie','Yanis','Clara']}
];



const claps={};(()=>{const all=[...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES,...ASSOCIATION_CHALLENGES];all.forEach(c=>{claps[c.id]={};[...new Set([...c.amis,'Moi'])].forEach(n=>claps[c.id][n]=Math.floor(Math.random()*101));});})();

/* √âtats */
const HABIT_DESC={}, HABIT_TITLE_CUSTOM={}, SPACE_DESC_TXT={};
const BASE_MINUTES={}, HABIT_MODE={}, LOCKED_COMMUN={}, LOCKED_BY={}, DONE_SETS={};
const HAS_DESC={}, DELETED_HABITS=new Set();

/* Fr√©quences */
const FREQ_MODE={};
function defaultFreqMode(h){if(h.type==='group'){return Math.random()<0.6?{type:'quotidien'}:{type:'tousx',x:2}}return Math.random()<0.4?{type:'quotidien'}:{type:'tousx',x:Math.floor(Math.random()*4)+2}}

/* Utils */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function fmtDate(d){const M=['01','02','03','04','05','06','07','08','09','10','11','12'][d.getMonth()];const j=String(d.getDate()).padStart(2,'0');const J=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][d.getDay()];return `${J} ${j}/${M}`;}
function genCode(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let s='';for(let i=0;i<6;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}
const round15=m=>Math.round(m/15)*15;function rint(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function pickQuarterUpTo75(){return 15*rint(1,5)}
function lvlEmoji(v){if(v<=7)return'üå∞';if(v<=14)return'üå±';if(v<=21)return'üçÄ';if(v<=28)return'üåº';if(v<=35)return'üåª';if(v<=42)return'üå∑';if(v<=49)return'üåπ';if(v<=56)return'ü™ª';if(v<=64)return'üíê';return'üéã';}
function names(xs,m=3){if(xs.length<=m)return xs.join(', ');const s=xs.slice(0,m).join(', ');return `${s}‚Ä¶ et ${xs.length-m} autres`;}
function m2txt(m){const h=Math.floor(m/60),mn=m%60;return `${h}h${String(mn).padStart(2,'0')}`;}
function m2txtShort(m){if(!m)return'-';const h=(m/60)|0, mn=m%60;return h?`${h}h${String(mn).padStart(2,'0')}`:`${mn}m`;}
const GENERIC_TIPS=["Commence petit et r√©gulier.","Pr√©pare ton mat√©riel √† l‚Äôavance.","Bloque un cr√©neau fixe au calendrier.","Annonce ton objectif √† un ami.","Trace tes progr√®s chaque jour.","C√©l√®bre chaque micro-victoire.","R√©duis la friction: rends l‚Äôaction √©vidente.","Associe l‚Äôhabitude √† un d√©clencheur simple.","Fais-le m√™me 2 minutes les jours difficiles.","Rends l‚Äôenvironnement compatible.","Supprime une distraction √©vidente.","Cr√©e une check-list de 3 √©tapes.","Plan B si tu rates ton horaire.","Ferme la boucle: fais un petit bilan.","Pr√©pare une version ‚Äòvoyage‚Äô minimaliste.","Utilise un rappel doux (alarme ou post-it).","Vis au rythme: respire avant de commencer.","Visualise le r√©sultat attendu.","Ralentis pour √™tre pr√©cis, puis acc√©l√®re.","Note une difficult√© & une solution.","Partage un retour d‚Äôexp√©rience avec un pair.","Automatise ce qui peut l‚Äô√™tre.","Range imm√©diatement apr√®s l‚Äôaction.","R√©compense-toi sans culpabilit√©.","Passe en mode avion 20 minutes."];
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function buildDesc(){return shuffle([...GENERIC_TIPS]).slice(0,7).join('\n')}
function oneLiner(s){return (s||'').replace(/\s*\n\s*/g,' ¬∑ ')}

/* Global */
let period='30', spaceId='D0PWE3', userName='Moi', dayOff=0;

/* Spaces */
const SPACES={'D0PWE3':{emoji:'üë§',label:'üë§ Individu',type:'private',ch:CHALLENGES,desc:'Jardin personnel.'},'E8D3FS':{emoji:'üè†',label:'üè† Colocation',type:'group',ch:GROUP_CHALLENGES,desc:'Jardin partag√© √† la maison.'},'AS50CI':{emoji:'üèõÔ∏è',label:'üèõÔ∏è Association',type:'group',ch:ASSOCIATION_CHALLENGES,desc:'Rituels d‚Äô√©quipe pour une asso.'},'WS32D7':{emoji:'üåû',label:'üåû Famille',type:'group',ch:FAMILY_CHALLENGES,desc:'Routines familiales au quotidien.'},'SR3S0D':{emoji:'üè´',label:'üè´ Classe',type:'group',ch:CLASS_CHALLENGES,desc:'Vie de classe et rituels p√©dagogiques.'},'PD03XZ':{emoji:'üè¢',label:'üè¢ Bureau',type:'group',ch:OFFICE_CHALLENGES,desc:'Rituels simples pour mieux travailler.'}};
const HABIT_TITLE_IS_CUSTOM={};

/* Init */
;[...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES,...ASSOCIATION_CHALLENGES].forEach(h=>{
  if(!FREQ_MODE[h.id]) FREQ_MODE[h.id]=defaultFreqMode(h);
});

/* Helpers */
function ensureHabit(hid){
 if(!BASE_MINUTES[hid]) BASE_MINUTES[hid]=pickQuarterUpTo75();
// 50% des habitudes sans description
if(HABIT_DESC[hid]===undefined){
HABIT_DESC[hid] = (Math.random()<0.5) ? '' : buildDesc();
}
  if(!HABIT_DESC[hid]) HABIT_DESC[hid]= HAS_DESC[hid] ? buildDesc() : '';
  if(!HABIT_MODE[hid]){
    const sp=getSpace();
    if(sp.type==='private'){HABIT_MODE[hid]={type:'libre',n:2}}
    else{ // collectif : libre ou commun uniquement
      HABIT_MODE[hid]= Math.random()<0.8 ? {type:'commun',n:2} : {type:'libre',n:2};
    }
  }
  if(!DONE_SETS[hid]) DONE_SETS[hid]=new Set();
  if(LOCKED_COMMUN[hid]===undefined){LOCKED_COMMUN[hid]=false;LOCKED_BY[hid]=null;}
}
function daySerial(d){return Math.floor(d.getTime()/86400000)}
function curDate(){const t=new Date();t.setHours(0,0,0,0);t.setDate(t.getDate()+dayOff);return t;}
function randDay(hid,serial){let h=0;const s=hid+':'+serial;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))>>>0;return (h%100)/100}

/* visibilit√© par fr√©quence */
function parseDDMMYYYY(str){const m=str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); d.setHours(0,0,0,0); return d;}
function isSameDay(a,b){return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate()}
function isVisibleToday(hid,d){
  const fm=FREQ_MODE[hid]||{type:'quotidien'};
  const serial=daySerial(d);
  let due=true;
  if(fm.type==='quotidien'){due=true}
  else if(fm.type==='tousx'){const x=Math.max(2, fm.x||2); due=((serial % x)===0)}
  else if(fm.type==='hebdo'){due=(d.getDay()===1)}
  else if(fm.type==='ponctuelle'){const dd=parseDDMMYYYY(fm.date||''); due=dd?isSameDay(d,dd):false}
  else if(fm.type==='jours'){const set=fm.days||new Set([1,2,3,4,5]); due=set.has(d.getDay());}
  const hidden=(randDay(hid,serial)<0.25);
  return due && !hidden;
}

function getSpace(){return SPACES[spaceId]||SPACES['D0PWE3'];}
function listChallenges(){return getSpace().ch;}
function findAny(id){return [...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES,...ASSOCIATION_CHALLENGES].find(c=>c.id===id);}
function habitLabel(it){const custom=HABIT_TITLE_CUSTOM[it.id];return custom&&custom.trim()?custom.trim():it.titre;}
function habitLabelById(id){const it=findAny(id);return it?habitLabel(it):''}

/* Dur√©e par clic: 0 -> base -> base+15 -> 0 */
function minutesFromState(base,st){if(st===1) return round15(base); if(st===2) return round15(base+15); return 0;}
function sumTodayMinutes(){return $$('#cards .levelBtn').map(b=>{const st=+b.dataset.state||0, base=+b.dataset.baseMin||0;return minutesFromState(base,st);}).reduce((a,b)=>a+b,0)}
function renderDateBar(){$("#dateLabel").textContent=fmtDate(curDate());$("#todayCount").textContent=m2txt(round15(sumTodayMinutes()));}

/* Emojis */
function currentBigEmoji(btn,tot){return btn.dataset.override|| (tot<=7?'üå∞':tot<=14?'üå±':tot<=21?'üçÄ':tot<=28?'üåº':tot<=35?'üåª':tot<=42?'üå∑':tot<=49?'üåπ':tot<=56?'ü™ª':tot<=64?'üíê':'üéã');}
function drawBtn(btn){const p=+btn.dataset.plants||0, s=+btn.dataset.suns||0, tot=p+s;const st=+btn.dataset.state||0, base=+btn.dataset.baseMin||0;const val=st===0?'√Ä faire':m2txtShort(minutesFromState(base,st));btn.innerHTML=`<div class="big">${currentBigEmoji(btn,tot)}</div><div class="scoreText">${val}</div>`;}

/* Description open/close */
let openCard=null;
function collapseOpenDesc(){if(!openCard) return;const d=openCard.querySelector('.desc');if(d){d.classList.remove('open');d.classList.add('hidden');d.textContent=d.dataset.short||'';}openCard.classList.remove('ready');openCard=null;}
document.addEventListener('click',e=>{if(openCard && !e.target.closest('.card')) collapseOpenDesc();},{capture:true})
function setupDesc(desc,hid){
desc.dataset.full=HABIT_DESC[hid]||'';desc.dataset.short=oneLiner(desc.dataset.full);desc.dataset.has=desc.dataset.full? '1':'0';
desc.textContent=desc.dataset.short;desc.classList.add('hidden');
}
/* D√©tail */
let activeId=null, refBtn=null;
function openDetail(id,btnRef){
  activeId=id;refBtn=btnRef;hideAll();$("#detail").classList.add('active');$("#daysWrap").classList.add('hide');
  $$('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="members"]').classList.add('active');
  $$('#detail .view').forEach(v=>v.classList.remove('active'));$('#tab-members').classList.add('active');
  const it=findAny(id);$("#detailTitle").textContent=`${it.emoji} ${habitLabel(it)}`;
  renderRank();populateCalWho();renderCalendar();renderHabitSettings();
}
function selectDetailTab(key){
  const b=[...document.querySelectorAll('#detail .tabs [data-tab]')].find(x=>x.dataset.tab===key); if(!b)return;
  document.querySelectorAll('#detail .tabs [data-tab]').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  document.querySelectorAll('#detail .section .view').forEach(v=>v.classList.remove('active'));
  document.querySelector(`#detail #${'tab-'+key}`)?.classList.add('active');
}

/* Cartes */
function renderCards(){
  const root=$("#cards");root.innerHTML='';const d=curDate();
  listChallenges().forEach(it=>{
    if(DELETED_HABITS.has(it.id)) return;
    if(!isVisibleToday(it.id,d)) return; ensureHabit(it.id);

    const card=document.createElement('article');card.className='card';
    const cont=document.createElement('div');cont.className='content';
    const title=document.createElement('div');title.className='title';
    const left=document.createElement('div');left.className='left';
    const displayTitle=habitLabel(it);
    left.innerHTML=`<span style="font-size:24px">${it.emoji}</span><span class="base">${displayTitle}</span><span class="hint" id="h-${it.id}"></span>`;
    title.append(left);

const pen=document.createElement('button');
pen.className='editPen'; pen.title='√âditer'; pen.textContent='‚úèÔ∏è';
pen.addEventListener('click',(e)=>{
e.stopPropagation();
openDetail(it.id,btn);
selectDetailTab('settings');
});
title.appendChild(pen);

    const desc=document.createElement('div');desc.className='desc';setupDesc(desc,it.id);
    const friends=document.createElement('div');friends.className='friends';
    // badge "seed" informatif (optionnel)
    if(Math.random()<.5){const n=rint(1,2);const seed=[...it.amis].sort(()=>Math.random()-.5).slice(0,n);const b=document.createElement('div');b.className='badge seed-badge';b.textContent=`üíß ${names(seed)}`;friends.appendChild(b)}
    cont.append(title,desc,friends);

    const col=document.createElement('div');col.className='levelCol';
    const btn=document.createElement('button');btn.className='levelBtn';btn.dataset.cid=it.id;
    const basePlants=Math.floor(Math.random()*65), suns=claps[it.id]?.['Moi']??0;
    btn.dataset.basePlants=String(basePlants);btn.dataset.plants=String(basePlants);btn.dataset.suns=String(suns);
    btn.dataset.baseMin=String(BASE_MINUTES[it.id]);btn.dataset.state='0';btn.dataset.override='';

    /* ne pas d√©placer les cartes en fin de liste */
    const setDoneVisual=(on)=>{const baseEl=title.querySelector('.base'); if(on){card.classList.add('done');baseEl.classList.add('strike');}else{card.classList.remove('done');baseEl.classList.remove('strike');}};
    const applySunBadge=(on)=>{const existing=friends.querySelector('.sun-badge'); if(existing) existing.remove(); if(!on) return; const b=document.createElement('div');b.className='badge sun-badge';const others=[...it.amis].sort(()=>Math.random()-.5).slice(0,rint(1,3));const who=new Set(others);who.add('Moi');b.textContent=`üåû ${names(Array.from(who),3)}`;friends.appendChild(b)};

    drawBtn(btn);
    updateHint(it.id, title.querySelector('.hint'));

 const ensureOpenDesc=()=>{ if(openCard!==card){ collapseOpenDesc(); openCard=card; }
    if(!desc.classList.contains('open')){ desc.classList.remove('hidden'); desc.classList.add('open'); desc.textContent=desc.dataset.full||''; }
 };
    const hideDescNow=()=>{ if(desc.classList.contains('open')){desc.classList.remove('open');desc.classList.add('hidden');desc.textContent=desc.dataset.short||'';openCard=null;title.querySelector('.editPen')?.remove();} };

    const advanceState=(next)=>{
      btn.dataset.state=String(next);drawBtn(btn);renderDateBar();
      if(next>0){ setDoneVisual(true); hideDescNow(); applySunBadge(true); }
      else{ setDoneVisual(false); applySunBadge(false); }
    };

    // r√®gles de clic simplifi√©es :
    // - si pas de description => 1er clic valide directement (state 1), 2e clic -> state 2, 3e -> 0
    // - si description => clic1 ouvre desc, clic2 -> state1, clic3 -> state2, clic4 -> 0
    const handleClick=()=>{
      const hasDesc = !!(HABIT_DESC[it.id]||'').trim();
      const isOpen = desc.classList.contains('open');
      const st = +btn.dataset.state||0;

      if(!hasDesc){
        // cycle direct 0->1->2->0
        const next = st===0?1 : st===1?2 : 0;
        advanceState(next);
        return;
      }
      // Avec description
      if(st===0 && !isOpen){ // 1er clic = ouvrir
        ensureOpenDesc();
        return;
      }
      // ensuite on cycle 0->1->2->0
      const next = st===0?1 : st===1?2 : 0;
      advanceState(next);
    };

    col.addEventListener('click',handleClick);
    cont.addEventListener('click',(e)=>{ if(e.target.closest('.badge')) return; handleClick(); });
    friends.addEventListener('click', (e) => {
  const badge = e.target.closest('.badge');
  if (!badge) return;
  e.stopPropagation();
  openDetail(it.id, btn);       // ouvre la fiche de l‚Äôhabitude
  selectDetailTab('members');   // et l‚Äôonglet "Jardiniers"
});
    col.append(btn);card.append(col,cont);root.appendChild(card);
  });
  renderDateBar();
}

/* Hints : uniquement en Collectif */
function updateHint(hid,el){
  if(!el) return;
  const sp=getSpace();
  if(sp.type!=='group'){ el.textContent=''; return; }
  const mode=HABIT_MODE[hid]||{type:'libre'};
  if(mode.type==='commun'){
    el.textContent = LOCKED_COMMUN[hid] ? `Collectif ¬∑ termin√©` : `Collectif`;
  }else{
    // libre en collectif : on affiche quand m√™me "Collectif" (plus discret possible)
    el.textContent = 'Collectif';
  }
}

/* ===== Calendriers ===== */
let calOff=0;
function minfo(off=0){const b=new Date();b.setDate(1);b.setMonth(b.getMonth()+off);const y=b.getFullYear(),m=b.getMonth();return{y,m,fd:(new Date(y,m,1).getDay()+6)%7,days:new Date(y,m+1,0).getDate()}}
function populateCalWho(){const sel=$("#calWho");sel.innerHTML='';sel.add(new Option('Tous','__all__'));sel.add(new Option('Moi','Moi'));(findAny(activeId)?.amis||[]).forEach(n=>sel.add(new Option(n,n)));sel.value='__all__';}
function renderCalendar(){
  const wrap=$("#cal");wrap.innerHTML='';const {y,m,fd,days}=minfo(calOff);const months=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];let monthMinutes=0;
  for(let i=0;i<fd;i++){const c=document.createElement('div');c.className='cell';c.style.opacity=.35;wrap.appendChild(c)}
  const today=new Date(),sameMonth=(calOff===0);
  for(let d=1;d<=days;d++){
    const c=document.createElement('div');c.className='cell';
    const dn=document.createElement('div');dn.className='dayNum';dn.textContent=String(d);c.appendChild(dn);
    if(Math.random()<0.6){
      const min=pickQuarterUpTo75();
      const mark=document.createElement('div');mark.className='seedMark';mark.textContent='üíß';c.appendChild(mark);
      const dur=document.createElement('div');dur.className='dur';dur.textContent=m2txtShort(min);c.appendChild(dur);
      monthMinutes+=min;
    }
    if(sameMonth&&d===today.getDate()){c.style.outline=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--green')}`}
    c.onclick=()=>{const b=new Date();b.setDate(1);b.setMonth(b.getMonth()+calOff);const tgt=new Date(b.getFullYear(),b.getMonth(),d),now=new Date();now.setHours(0,0,0,0);dayOff=Math.round((tgt-now)/86400000);showHome();renderCards();renderDateBar();window.scrollTo({top:0,behavior:'smooth'})};
    wrap.appendChild(c);
  }
  $("#monthLabel").textContent=`${months[m]} ${y}  üíß${m2txt(round15(monthMinutes))}`;
}
$("#prevMonth").onclick=()=>{calOff--;renderCalendar()};$("#nextMonth").onclick=()=>{calOff++;renderCalendar()};$("#calWho")?.addEventListener('change',renderCalendar);

/* ===== Navigation vues ===== */
function showHome(){hideAll();$("#home").classList.add('active');$("#daysWrap").classList.remove('hide')}
function hideAll(){$$('#home,#detail,#space').forEach(v=>v.classList.remove('active'))}
$("#backHome").onclick=showHome;

/* ===== Classement ===== */
function demoHM(rangeDays){const min=round15(rint(30,25*60));return {min, txt:m2txt(min)}}
function likeFactorFromMin(min){return 0.5+(min/60)/25}
function makeLikeBtn(base){const b=document.createElement('button');b.className='btn likeBtn';b.textContent=`üåû ${base}`;b.dataset.base=String(base);b.dataset.liked='0';b.onclick=()=>{const liked=b.dataset.liked==='1';b.dataset.liked=liked?'0':'1';b.textContent=`üåû ${liked?b.dataset.base:(+b.dataset.base+1)}`;b.style.outline=liked?'none':'2px solid var(--green)'};return b}
function renderRank(){
  const it=findAny(activeId);const days=period==='7'?7:period==='30'?30:120;
  const rows=[...it.amis.map(n=>({n,me:false})),{n:userName||'Moi',me:true}].map(x=>{const v=demoHM(days);const baseLikes=Math.max(0,Math.round(v.min/60*likeFactorFromMin(v.min)));return {...x,totalMin:v.min,txt:v.txt,likes:baseLikes};}).sort((a,b)=>b.totalMin-a.totalMin);
  const root=$("#rank");root.innerHTML='';rows.forEach(({n,totalMin,txt,me,likes})=>{const row=document.createElement('div');row.className='row';const left=document.createElement('div');left.className='leftRank';const big=document.createElement('span');big.className='scoreEmoji';big.textContent=`${lvlEmoji(Math.min(65,Math.round(totalMin/60)))} ${txt}`;const name=document.createElement('b');name.textContent=`${n}${me?' (toi)':''}`;left.append(big,name);const like=makeLikeBtn(likes);row.append(left,like);root.appendChild(row);});
}
function updPeriodBtns(){$$('#btnP7,#btnP30,#btnPAll').forEach(b=>b.classList.toggle('active',b.dataset.period===period))}
$('#btnP7').onclick=()=>{period='7';updPeriodBtns();renderRank()};$('#btnP30').onclick=()=>{period='30';updPeriodBtns();renderRank()};$('#btnPAll').onclick=()=>{period='all';updPeriodBtns();renderRank()};

/* ===== Param√®tres habitude ===== */
function renderHabitSettings(){
  if(!activeId)return; ensureHabit(activeId);
  const it=findAny(activeId);

  // titre
  const titleInput=$("#habitTitleInput"), emojiEl=$("#habitTitleEmoji");
  if(it&&titleInput&&emojiEl){
    emojiEl.textContent=it.emoji||'üå±';
    if(document.activeElement!==titleInput) titleInput.value=habitLabel(it);
    if(!titleInput.dataset.bound){
      titleInput.addEventListener('input',()=>{const raw=titleInput.value; if(raw.trim()){HABIT_TITLE_CUSTOM[activeId]=raw;}else{delete HABIT_TITLE_CUSTOM[activeId];} $("#detailTitle").textContent=`${it.emoji} ${habitLabel(it)}`; renderCards();});
      titleInput.dataset.bound='1';
    }
  }
  // description
  const desc=$("#habitDesc");
  if(desc){ desc.value=HABIT_DESC[activeId]||''; if(!desc.dataset.bound){ desc.addEventListener('input',()=>{HABIT_DESC[activeId]=desc.value;HAS_DESC[activeId]=!!desc.value.trim();renderCards();}); desc.dataset.bound='1'; } }

  // mode de r√©alisation (libre / commun)
  const modeSel=$("#modeSelect");
  if(modeSel){
    const m=HABIT_MODE[activeId]||{type:'libre',n:2};
    modeSel.value=(m.type==='commun')?'commun':'libre';
    modeSel.onchange=()=>{const t=modeSel.value;HABIT_MODE[activeId]={type:t,n:2};renderCards();};
  }

  // fr√©quence
  const ft=$("#freqType"), fx=$("#freqX"), fDate=$("#freqDate"), fJ=$("#freqSubJours");
  if(ft&&fx&&fDate&&fJ){
    const fm=FREQ_MODE[activeId]||(FREQ_MODE[activeId]=defaultFreqMode(it));
    const setUI=()=>{
      ft.value=fm.type||'quotidien';
      $("#freqSubTousx").classList.toggle('hide',ft.value!=='tousx');
      $("#freqSubPonctuelle").classList.toggle('hide',ft.value!=='ponctuelle');
      fJ.classList.toggle('hide',ft.value!=='jours'); // jours visibles uniquement si "jours"
      if(fm.type==='tousx'){fx.value=String(fm.x||2)}
      if(fm.type==='ponctuelle'){fDate.value=fm.date||''}
      if(fm.type==='jours'){fJ.querySelectorAll('input[type=checkbox]').forEach(cb=>{cb.checked = fm.days?fm.days.has(+cb.value):false;});}
    };
    setUI();
    if(!ft.dataset.bound){
      ft.onchange=()=>{const v=ft.value; if(v==='tousx')FREQ_MODE[activeId]={type:'tousx',x:parseInt(fx.value||'2',10)}; else if(v==='ponctuelle')FREQ_MODE[activeId]={type:'ponctuelle',date:(fDate.value||'')}; else if(v==='jours')FREQ_MODE[activeId]={type:'jours',days:new Set()}; else if(v==='hebdo')FREQ_MODE[activeId]={type:'hebdo'}; else FREQ_MODE[activeId]={type:'quotidien'}; setUI(); renderCards(); };
      fx.onchange=()=>{const x=parseInt(fx.value||'2',10);FREQ_MODE[activeId]={...(FREQ_MODE[activeId]||{}),type:'tousx',x}; renderCards();};
      fDate.oninput=()=>{FREQ_MODE[activeId]={...(FREQ_MODE[activeId]||{}),type:'ponctuelle',date:fDate.value}; renderCards();};
      fJ.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.addEventListener('change',()=>{const days=new Set(FREQ_MODE[activeId]?.days||[]); if(cb.checked)days.add(+cb.value); else days.delete(+cb.value); FREQ_MODE[activeId]={type:'jours',days}; renderCards();}));
      ft.dataset.bound='1';
    }
  }

  // supprimer
  const del=$("#deleteHabitBtn");
  if(del && !del.dataset.bound){
    del.onclick=()=>{ if(confirm('Supprimer cette habitude ?')){ DELETED_HABITS.add(activeId); showHome(); renderCards(); } };
    del.dataset.bound='1';
  }
}

/* ===== Espace ===== */
function openSpacePage(){hideAll();$("#space").classList.add('active');$("#daysWrap").classList.add('hide');updSpaceHeader();renderSpaceRank();setupSpaceInfo();populateSpaceWho();renderSpaceCalendar();maybeTogglePrivateAdd();}
function updSpaceHeader(){const sp=getSpace();$("#spaceHeaderTitle").textContent=sp.label;$("#paramSpaceLabel").value=sp.label;$("#paramName").value=userName||'Moi'}
function setupSpaceInfo(){const sp=getSpace();const t=$("#spaceDescInfo");t.value=SPACE_DESC_TXT[spaceId]??(sp.desc||'');t.classList.add('editing');t.oninput=()=>{SPACE_DESC_TXT[spaceId]=t.value;sp.desc=t.value}}
function allMembersOfSpace(){const ch=listChallenges();const set=new Set(['Moi']);ch.forEach(c=>c.amis.forEach(a=>set.add(a)));return Array.from(set)}
function renderSpaceRank(){
  const root = $("#spaceRank"); root.innerHTML = '';
  const days = sPeriod==='7' ? 7 : (sPeriod==='30' ? 30 : 120);
  const rows = allMembersOfSpace().map(n=>{const v = demoHM(days);const baseLikes = Math.max(0, Math.round(v.min/60 * likeFactorFromMin(v.min)));return { n, txt:v.txt, min:v.min, me:(n===userName||n==='Moi'), likes:baseLikes };}).sort((a,b)=>b.min-a.min);
  rows.forEach(({n,txt,min,me,likes})=>{const row=document.createElement('div'); row.className='row';const left=document.createElement('div'); left.className='leftRank';const big=document.createElement('span'); big.className='scoreEmoji';big.textContent = `${lvlEmoji(Math.min(65,Math.round(min/60)))} ${txt}`;const name=document.createElement('b'); name.textContent = `${n}${me?' (toi)':''}`;left.append(big,name);const like = makeLikeBtn(likes);row.append(left, like);root.appendChild(row);});
}
let sPeriod = '30';
function updSpacePeriodBtns(){$$('#sBtnP7,#sBtnP30,#sBtnPAll').forEach(b=>b.classList.toggle('active', b.dataset.speriod===sPeriod));}
$('#sBtnP7').onclick = ()=>{ sPeriod='7';  updSpacePeriodBtns(); renderSpaceRank(); };
$('#sBtnP30').onclick= ()=>{ sPeriod='30'; updSpacePeriodBtns(); renderSpaceRank(); };
$('#sBtnPAll').onclick = ()=>{ sPeriod='all';updSpacePeriodBtns(); renderSpaceRank(); };

let sCalOff=0;
function populateSpaceWho(){const sel=$("#sCalWho");sel.innerHTML='';sel.add(new Option('Tous','__all__'));allMembersOfSpace().forEach(n=>sel.add(new Option(n,n)));sel.value='__all__';}
function renderSpaceCalendar(){
  const wrap=$("#sCal");wrap.innerHTML='';const {y,m,fd,days}=minfo(sCalOff);const months=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];let monthMinutes=0;
  for(let d=1,i=0;i<fd;i++){const c=document.createElement('div');c.className='cell';c.style.opacity=.35;wrap.appendChild(c)}
  for(let d=1;d<=days;d++){
    const c=document.createElement('div');c.className='cell';const dn=document.createElement('div');dn.className='dayNum';dn.textContent=String(d);c.appendChild(dn);
    if(Math.random()<0.65){const mins=pickQuarterUpTo75();const mark=document.createElement('div');mark.className='seedMark';mark.textContent='üíß';c.appendChild(mark);const dur=document.createElement('div');dur.className='dur';dur.textContent=m2txtShort(mins);c.appendChild(dur);monthMinutes+=mins;}
    wrap.appendChild(c);
  }
  $("#sMonthLabel").textContent=`${months[m]} ${y}  üíß${m2txt(round15(monthMinutes))}`;
}
$("#sPrevMonth").onclick=()=>{sCalOff--;renderSpaceCalendar()};$("#sNextMonth").onclick=()=>{sCalOff++;renderSpaceCalendar()};$("#sCalWho").addEventListener('change',renderSpaceCalendar);

/* S√©lecteur d‚Äôespace */
function updSel(){const sel=$("#spaceSel");sel.innerHTML='';const order=['E8D3FS','AS50CI','D0PWE3','WS32D7','SR3S0D','PD03XZ'];order.forEach(id=>{if(SPACES[id]){const o=document.createElement('option');o.value=id;o.textContent=SPACES[id].label;sel.appendChild(o)}});Object.keys(SPACES).forEach(id=>{if(!order.includes(id)){const o=document.createElement('option');o.value=id;o.textContent=SPACES[id].label;sel.appendChild(o)}});sel.value=spaceId;}
const selSpace=$("#spaceSel");selSpace.addEventListener('change',()=>{spaceId=selSpace.value;renderCards();showHome();});
$("#openSpace").onclick=openSpacePage;$("#backFromSpace").onclick=showHome;

/* Modales */
const mAdd=$("#modalAdd"),mHabit=$("#modalHabit"),mInvite=$("#modalInvite"),mSpace=$("#modalSpace"),mWizard=$("#modalWizard");
const open=m=>m.classList.add('on'), close=m=>m.classList.remove('on');
$("#addBtn").onclick=()=>{open(mAdd);maybeTogglePrivateAdd();};$("#closeAdd").onclick=()=>close(mAdd);
$("#addHabit").onclick=()=>{close(mAdd);open(mHabit);step1()}
function maybeTogglePrivateAdd(){ const isPrivate=getSpace().type==='private'; $("#addPrivateHabit").classList.toggle('hide',!isPrivate); }
$("#addPrivateHabit").onclick=()=>{
  close(mAdd);
  const id='priv_'+genCode();
  const h={type:'private',id,cat:'sante',emoji:'‚ú®',titre:'Nouvelle habitude priv√©e ‚ú®',amis:[]};
  CHALLENGES.unshift(h);
  HAS_DESC[id]=Math.random()<0.5; HABIT_DESC[id]=HAS_DESC[id]?buildDesc():'';
  FREQ_MODE[id]={type:'quotidien'}; HABIT_MODE[id]={type:'libre',n:2};
  activeId=id; renderCards(); openDetail(id,null); selectDetailTab('settings');
};
$("#inviteFriend").onclick=()=>{close(mAdd);openInvite()};$("#joinSpace").onclick=()=>{close(mAdd);open(mSpace)};
function openInvite(){const code=spaceId;$("#inviteLink").value=`https://habitu.be/?code=${code}`;open(mInvite)}
$("#closeInvite").onclick=()=>close(mInvite);$("#copyInvite").onclick=async()=>{try{await navigator.clipboard.writeText($("#inviteLink").value);alert("Lien copi√© !")}catch(e){alert("Copie impossible")}}
$("#spaceGen").onclick=()=>{$("#spaceCode").value=genCode()};$("#spaceCancel").onclick=()=>close(mSpace);$("#closeSpace").onclick=()=>close(mSpace);

/* Space join/wizard */
$("#spaceSave").onclick=()=>{const code=($("#spaceCode").value||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6), name=($("#spaceName").value||'').trim()||'Moi'; if(!code){alert("Entre un code de jardin.");return} if(SPACES[code]){spaceId=code;userName=name;updSel();renderCards();close(mSpace)} else{close(mSpace);launchWizard(code,name)}};
let wiz={code:'',name:'',type:'private',profile:'Autre'};
function launchWizard(code,name){wiz={code,name,type:'private',profile:'Autre'};open(mWizard);wizProfileStep()}
function wizProfileStep(){const root=$("#wizStep");$("#wizTitle").textContent="Type de profil";root.innerHTML='';[
  {emoji:'üë§',label:'Individu',apply:()=>({emoji:'üë§',label:'üë§ Individu',type:'private',ch:CHALLENGES,desc:'Jardin personnel.'})},
  {emoji:'üè†',label:'Colocation',apply:()=>({emoji:'üè†',label:'üè† Colocation',type:'group',ch:GROUP_CHALLENGES,desc:'Jardin partag√© √† la maison.'})},
  {emoji:'üèõÔ∏è',label:'Association',apply:()=>({emoji:'üèõÔ∏è',label:'üèõÔ∏è Association',type:'group',ch:ASSOCIATION_CHALLENGES,desc:'Rituels d‚Äô√©quipe pour une asso.'})},
  {emoji:'üåû',label:'Famille',apply:()=>({emoji:'üåû',label:'üåû Famille',type:'group',ch:FAMILY_CHALLENGES,desc:'Routines familiales au quotidien.'})},
  {emoji:'üè´',label:'Classe',apply:()=>({emoji:'üè´',label:'üè´ Classe',type:'group',ch:CLASS_CHALLENGES,desc:'Vie de classe.'})},
  {emoji:'üè¢',label:'Bureau',apply:()=>({emoji:'üè¢',label:'üè¢ Bureau',type:'group',ch:OFFICE_CHALLENGES,desc:'Rituels simples pour mieux travailler.'})},
  {emoji:'‚ú®',label:'Autre',apply:()=>({emoji:'‚ú®',label:'‚ú® Autre',type:'group',ch:GROUP_CHALLENGES,desc:'Jardin partag√©.'})}
].forEach(o=>{const el=document.createElement('div');el.className='opt';el.innerHTML=`<div class="emoji">${o.emoji}</div><div><b>${o.label}</b></div>`;el.onclick=()=>{const d=o.apply();SPACES[wiz.code]=d;spaceId=wiz.code;userName=wiz.name;updSel();renderCards();close(mWizard);};root.appendChild(el);});}
$("#closeWizard").onclick=()=>close(mWizard);
$("#quitSpaceBtn").onclick=()=>{const sp=getSpace();if(confirm(`Quitter ${sp.label} ?`)){spaceId='D0PWE3';updSel();renderCards();showHome()}}

/* Ajout habitude (catalogue) */
let pickedCat=null;
function step1(){const root=$("#step1");$("#step1").style.display='grid';$("#step2").style.display='none';root.innerHTML='';CATS.forEach(c=>{const el=document.createElement('div');el.className='opt';el.innerHTML=`<div class="emoji">${c.emoji}</div><div><b>${c.nom}</b></div>`;el.onclick=()=>{pickedCat=c.id;step2()};root.appendChild(el)})}
function step2(){const root=$("#step2");$("#step1").style.display='none';$("#step2").style.display='grid';root.innerHTML='';CHALLENGES.filter(x=>x.cat===pickedCat).forEach(x=>{const el=document.createElement('div');el.className='opt';el.innerHTML=`<div class="emoji">${x.emoji}</div><div><b>${x.titre}</b></div>`;el.onclick=()=>{alert("Habitude ajout√©e (d√©mo)");close(mHabit)};root.appendChild(el)})}
$("#closeHabit").onclick=()=>close(mHabit);

/* Jour +/- */
$("#prevDay").onclick=()=>{dayOff--;renderCards();renderDateBar()};$("#nextDay").onclick=()=>{dayOff++;renderCards();renderDateBar()};

/* Lancement */
function renderCalendarAndKeepMonth(){renderCalendar()}
let dayInit=false;function renderDateOnce(){if(!dayInit){dayOff=0;renderDateBar();dayInit=true}}
function updAll(){renderCards();renderCalendarAndKeepMonth();renderDateOnce();updSel();maybeTogglePrivateAdd()}
updAll();

/* Tabs util */
function switchViews(btn,groupAttr,prefix){const key=btn.getAttribute(groupAttr);document.querySelectorAll(`.tabs [${groupAttr}]`).forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.querySelectorAll(`#${prefix} .view`).forEach(v=>v.classList.remove('active'));const target=document.querySelector(`#${prefix} #${(groupAttr==='data-tab'?'tab-':'')}${key}`);if(target)target.classList.add('active');if(key==='history'){populateCalWho?.();renderCalendar?.()}if(key==='shistory'){populateSpaceWho?.();renderSpaceCalendar?.()}}
document.querySelectorAll('#detail .tabs [data-tab]').forEach(btn=>{btn.addEventListener('click',()=>switchViews(btn,'data-tab','detail').bind(null))});
document.querySelectorAll('#space .tabs [data-stab]').forEach(btn=>{btn.addEventListener('click',()=>switchViews(btn,'data-stab','space').bind(null))});
</script>
</body></html>
